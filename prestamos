<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrÃ©stamos Semana</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --stroke:rgba(255,255,255,.08);
      --text:#eaf0ff; --muted:rgba(234,240,255,.65);
      --green:#2ee59d; --red:#ff4d4d;
      --r:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px; font-family:var(--sans); color:var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(46,229,157,.16), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(255,77,77,.12), transparent 60%),
                  var(--bg);
    }
    .wrap{max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:14px}
    .topbar{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);
      border-radius:var(--r);box-shadow:var(--shadow);
    }
    h1{margin:0;font-size:16px;font-weight:900}
    .sub{font-family:var(--mono);font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search{
      display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:999px;
      border:1px solid var(--stroke);background:rgba(255,255,255,.03);min-width:240px;
    }
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--text);font-size:13px}
    .pill{
      padding:9px 12px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);color:var(--text);cursor:pointer;font-size:12px;font-weight:800;
    }
    .pill:hover{background:rgba(255,255,255,.06)}
    .section{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.2px;text-transform:uppercase}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{
      border-radius:var(--r);border:1px solid var(--stroke);
      background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      box-shadow:var(--shadow);overflow:hidden;
    }
    .ch{
      padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--stroke);background:rgba(0,0,0,.10);
    }
    .name{font-weight:950;font-size:14px}
    .badge{
      border:1px solid var(--stroke);background:rgba(255,255,255,.03);
      padding:6px 10px;border-radius:999px;font-size:11px;color:var(--muted);font-family:var(--mono);
      white-space:nowrap;
    }
    .kpis{padding:10px 14px 14px;display:grid;grid-template-columns:1fr;gap:10px}
    .kpi{
      display:flex;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);background:rgba(18,26,39,.55);
    }
    .label{font-size:12px;color:var(--muted);font-weight:800}
    .value{font-size:15px;font-weight:950;font-family:var(--mono);text-align:right}
    .red{color:var(--red)} .green{color:var(--green)}
    .loading{
      padding:14px;border:1px dashed var(--stroke);border-radius:var(--r);
      background:rgba(255,255,255,.02);font-family:var(--mono);color:var(--muted)
    }
    @media(min-width:760px){ .kpis{grid-template-columns:1fr 1fr} .search{min-width:320px} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>PrÃ©stamos Semana</h1>
      <div class="sub" id="range">â€”</div>
    </div>
    <div class="controls">
      <div class="search">
        <span style="opacity:.75;font-family:var(--mono);font-size:12px;">ðŸ”Ž</span>
        <input id="q" placeholder="Buscar grupoâ€¦" autocomplete="off" />
      </div>
      <button class="pill" id="sortBtn">Orden: Balance pendiente â†“</button>
    </div>
  </div>

  <div class="section">General</div>
  <div id="general"></div>

  <div class="section">Grupos</div>
  <div id="list" class="grid"></div>

  <div id="loading" class="loading">Cargando datosâ€¦</div>
</div>

<script>
  // âœ… PON AQUÃ TU WEB APP URL
  const API_URL = "https://script.google.com/macros/s/AKFYCB_TU_ID/exec";

  const qs = new URLSearchParams(location.search);
  const get = (k, d="") => (qs.get(k) ?? d);

  const moneyRD = (n) => "RD$ " + Number(n||0).toLocaleString("es-DO",{minimumFractionDigits:2,maximumFractionDigits:2});

  const buildCard = (title, meta, r) => {
    const bp = Number(r.balancePendiente||0);
    const ab = Number(r.totalAbonos||0);
    const ps = Number(r.prestamosSemana||0);

    return `
      <div class="card">
        <div class="ch">
          <div class="name">${escapeHtml(title)}</div>
          <div class="badge">${escapeHtml(meta||"")}</div>
        </div>
        <div class="kpis">
          <div class="kpi"><div class="label">Balance inicial</div><div class="value">${moneyRD(r.balanceInicial)}</div></div>
          <div class="kpi"><div class="label">Balance pendiente</div><div class="value red">${moneyRD(bp)}</div></div>
          <div class="kpi"><div class="label">Total de abonos</div><div class="value green">${moneyRD(ab)}</div></div>
          <div class="kpi"><div class="label">PrÃ©stamos de semana</div><div class="value ${ps>0?"red":""}">${moneyRD(ps)}</div></div>
          <div class="kpi" style="grid-column:1/-1;"><div class="label">Balance general</div><div class="value">${moneyRD(r.balanceGeneral)}</div></div>
        </div>
      </div>
    `;
  };

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // JSONP loader (para saltar CORS desde GitHub)
  function loadJSONP(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      script.onerror = () => { cleanup(); reject(new Error("JSONP error")); };
      document.head.appendChild(script);

      function cleanup() {
        delete window[cb];
        script.remove();
      }
    });
  }

  // --- UI ---
  let rows = [];
  let sortDesc = true;
  const list = document.getElementById("list");
  const general = document.getElementById("general");
  const loading = document.getElementById("loading");
  const q = document.getElementById("q");
  const sortBtn = document.getElementById("sortBtn");

  function render() {
    const term = (q.value||"").trim().toLowerCase();
    let filtered = rows.filter(r => String(r.grupo||"").toLowerCase().includes(term));

    filtered.sort((a,b) => sortDesc
      ? (Number(b.balancePendiente||0) - Number(a.balancePendiente||0))
      : (Number(a.balancePendiente||0) - Number(b.balancePendiente||0))
    );

    list.innerHTML = filtered.map(r => buildCard(
      String(r.grupo||"").replace("GRUPO","").trim() || "â€”",
      "Grupo",
      r
    )).join("");
  }

  sortBtn.addEventListener("click", () => {
    sortDesc = !sortDesc;
    sortBtn.textContent = `Orden: Balance pendiente ${sortDesc ? "â†“" : "â†‘"}`;
    render();
  });
  q.addEventListener("input", render);

  (async function init(){
    const fechalunes = get("fechalunes","");
    const fechadomingo = get("fechadomingo","");
    document.getElementById("range").textContent =
      (fechalunes && fechadomingo) ? `Semana: ${fechalunes} â†’ ${fechadomingo}` : "Semana: (desde Sheets)";

    const API_URL = "https://script.google.com/macros/s/AKfycbzovtDWBgD6RWMZAaN-PKb6ZFCGiMZ7H7pnWHz8IPvb1vSxWg6cFiSHHF1w0bwE1L_k/exec";

const url =
  API_URL
  + "?fechalunes=" + encodeURIComponent(fechalunes)
  + "&fechadomingo=" + encodeURIComponent(fechadomingo);


    try{
      const data = await loadJSONP(url);
      loading.style.display = "none";

      // general + grupos
      general.innerHTML = buildCard("GENERAL", data?.meta?.fechalunes ? `${data.meta.fechalunes} â†’ ${data.meta.fechadomingo}` : "Resumen", data.general || {});
      rows = Array.isArray(data.grupos) ? data.grupos : [];
      render();
    }catch(err){
      loading.textContent = "Error cargando datos. Revisa la URL del Web App y permisos.";
      console.error(err);
    }
  })();
</script>
</body>
</html>
