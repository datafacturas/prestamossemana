<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrÃ©stamos Semana</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a27;
      --card2:#0f1622;
      --stroke: rgba(255,255,255,.08);
      --text:#eaf0ff;
      --muted: rgba(234,240,255,.65);

      --green:#2ee59d;
      --red:#ff4d4d;

      --radius:18px;
      --pad:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(46,229,157,.16), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(255,77,77,.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      padding: 18px;
    }

    .wrap{
      max-width: 820px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 240px;
    }
    .title h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      font-weight: 800;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .search{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      min-width: 220px;
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color: var(--text);
      font-size: 13px;
    }
    .pill{
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
      font-weight: 700;
    }
    .pill:hover{ background: rgba(255,255,255,.06); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-header{
      padding: 12px var(--pad);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(0,0,0,.10);
    }
    .card-header .left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card-header .name{
      font-weight: 900;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
      white-space: nowrap;
    }

    .kpis{
      padding: 10px var(--pad) 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .kpi{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(18,26,39,.55);
    }
    .kpi .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .kpi .value{
      font-size: 15px;
      font-weight: 900;
      letter-spacing:.2px;
      text-align:right;
      font-family: var(--mono);
    }

    .value.red{ color: var(--red); }
    .value.green{ color: var(--green); }

    .note{
      margin-top: 2px;
      font-size: 11px;
      color: rgba(234,240,255,.55);
      font-family: var(--mono);
      padding: 0 var(--pad) 12px;
    }

    .section-title{
      margin: 2px 2px 0;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.25px;
      text-transform: uppercase;
    }

    .empty{
      padding: 14px;
      color: var(--muted);
      border: 1px dashed var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
      font-family: var(--mono);
      font-size: 12px;
    }

    @media (min-width: 720px){
      .kpis{ grid-template-columns: 1fr 1fr; }
      .search{ min-width: 300px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>PrÃ©stamos Semana</h1>
        <div class="sub" id="range">â€”</div>
      </div>

      <div class="controls">
        <div class="search">
          <span style="opacity:.75;font-family:var(--mono);font-size:12px;">ðŸ”Ž</span>
          <input id="q" placeholder="Buscar grupoâ€¦" autocomplete="off" />
        </div>
        <button class="pill" id="sortBtn">Orden: Balance pendiente â†“</button>
      </div>
    </div>

    <div class="section-title">General</div>
    <div id="generalCard"></div>

    <div class="section-title">Grupos</div>
    <div class="grid" id="list"></div>

    <div id="empty" class="empty" style="display:none;">
      No hay datos en <code>rows</code>. Revisa el link que manda AppSheet.
    </div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);

  const get = (k, d="") => {
    const v = qs.get(k);
    return (v === null || v === undefined) ? d : v;
  };

  // --- Parse number robust (accept "8787238.36", "8,787,238.36", "8.787.238,36", "RD$ 8,787,238.36") ---
  const toNum = (v, def=0) => {
    if (v === null || v === undefined || v === "") return def;
    let s = String(v).trim();
    s = s.replace(/[^\d.,-]/g,"");
    if (!s) return def;

    const lastComma = s.lastIndexOf(",");
    const lastDot   = s.lastIndexOf(".");

    if (lastComma > lastDot) {
      // decimal comma: 8.787.238,36
      s = s.replace(/\./g,"");
      s = s.replace(/,/g,".");
    } else {
      // decimal dot: 8,787,238.36
      s = s.replace(/,/g,"");
    }
    const n = Number(s);
    return Number.isFinite(n) ? n : def;
  };

  const moneyRD = (n) => {
    const num = Number(n || 0);
    return "RD$ " + num.toLocaleString("es-DO", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  // --- Input format ---
  // general = BI^BP^AB^PS^BG
  // rows    = Grupo^BI^BP^AB^PS^BG ; Grupo2^... ; ...
  const parsePacked = (packed) => {
    if (!packed) return null;
    const parts = String(packed).split("^");
    return {
      balance_inicial: toNum(parts[0], 0),
      balance_pendiente: toNum(parts[1], 0),
      total_abonos: toNum(parts[2], 0),
      prestamos_semana: toNum(parts[3], 0),
      balance_general: toNum(parts[4], 0),
    };
  };

  const buildCard = ({ title, meta, data }) => {
    const bp = data.balance_pendiente;
    const ab = data.total_abonos;
    const ps = data.prestamos_semana;

    return `
      <div class="card">
        <div class="card-header">
          <div class="left">
            <div class="name">${escapeHtml(title)}</div>
          </div>
          <div class="badge">${escapeHtml(meta || "")}</div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">Balance inicial</div>
            <div class="value">${moneyRD(data.balance_inicial)}</div>
          </div>

          <div class="kpi">
            <div class="label">Balance pendiente</div>
            <div class="value red">${moneyRD(bp)}</div>
          </div>

          <div class="kpi">
            <div class="label">Total de abonos</div>
            <div class="value green">${moneyRD(ab)}</div>
          </div>

          <div class="kpi">
            <div class="label">PrÃ©stamos de semana</div>
            <div class="value ${ps > 0 ? "red" : ""}">${moneyRD(ps)}</div>
          </div>

          <div class="kpi" style="grid-column: 1 / -1;">
            <div class="label">Balance general</div>
            <div class="value">${moneyRD(data.balance_general)}</div>
          </div>
        </div>

        <div class="note">Formato: BI / BP / AB / PS / BG</div>
      </div>
    `;
  };

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // --- Read params ---
  const lunes = get("fechalunes","");
  const domingo = get("fechadomingo","");
  const range = (lunes && domingo) ? `Semana: ${lunes} â†’ ${domingo}` : "â€”";
  document.getElementById("range").textContent = range;

  // --- General ---
  const generalPacked = get("general","");
  const gdata = parsePacked(generalPacked) || {
    balance_inicial: 0, balance_pendiente: 0, total_abonos: 0, prestamos_semana: 0, balance_general: 0
  };

  document.getElementById("generalCard").innerHTML = buildCard({
    title: "GENERAL",
    meta: (lunes && domingo) ? `${lunes} â†’ ${domingo}` : "Resumen",
    data: gdata
  });

  // --- Rows ---
  const rowsRaw = get("rows","");
  let rows = [];
  if (rowsRaw) {
    rows = String(rowsRaw)
      .split(";")
      .map(s => s.trim())
      .filter(Boolean)
      .map(line => {
        const p = line.split("^");
        const grupo = decodeURIComponent(p[0] || "").trim() || "â€”";
        return {
          grupo,
          balance_inicial: toNum(p[1], 0),
          balance_pendiente: toNum(p[2], 0),
          total_abonos: toNum(p[3], 0),
          prestamos_semana: toNum(p[4], 0),
          balance_general: toNum(p[5], 0),
        };
      });
  }

  const empty = document.getElementById("empty");
  if (!rows.length) {
    empty.style.display = "block";
  }

  // --- Sorting + search ---
  let sortDesc = true;
  const sortBtn = document.getElementById("sortBtn");
  const q = document.getElementById("q");
  const list = document.getElementById("list");

  const renderList = () => {
    const term = (q.value || "").trim().toLowerCase();

    let filtered = rows.filter(r => r.grupo.toLowerCase().includes(term));

    filtered.sort((a,b) => sortDesc
      ? (b.balance_pendiente - a.balance_pendiente)
      : (a.balance_pendiente - b.balance_pendiente)
    );

    list.innerHTML = filtered.map(r => buildCard({
      title: r.grupo,
      meta: "Grupo",
      data: r
    })).join("");
  };

  sortBtn.addEventListener("click", () => {
    sortDesc = !sortDesc;
    sortBtn.textContent = `Orden: Balance pendiente ${sortDesc ? "â†“" : "â†‘"}`;
    renderList();
  });

  q.addEventListener("input", renderList);

  renderList();
</script>
</body>
</html>
