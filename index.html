<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pr√©stamos de Semana</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --stroke:rgba(15,23,42,.10);
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --r:18px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --red:#ef4444;
      --green:#10b981;
      --blue:#2563eb;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(16,185,129,.08), transparent 60%),
        var(--bg);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; display:flex; flex-direction:column; gap:14px; }

    .topbar{
      background:var(--card);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      border-radius:var(--r);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title{ display:flex; flex-direction:column; gap:4px; }
    h1{ margin:0; font-size:16px; font-weight:950; letter-spacing:.2px; }
    .sub{ font-family:var(--mono); font-size:12px; color:var(--muted); }

    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .search{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff;
      min-width:260px;
    }
    .search input{
      width:100%;
      border:0; outline:0;
      font-size:13px;
      background:transparent;
      color:var(--text);
    }
    .btn{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
    }
    .btn:hover{ background:#f8fafc; }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      border-radius:var(--r);
      overflow:hidden;
    }
    .card-h{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(37,99,235,.06), rgba(37,99,235,0));
    }
    .name{
      font-weight:950;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      background:rgba(15,23,42,.04);
      border:1px solid var(--stroke);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .kpis{
      padding:12px 14px 14px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media(min-width:520px){
      .kpis{ grid-template-columns:1fr 1fr; }
      .kpis .wide{ grid-column:1/-1; }
    }
    .kpi{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
    }
    .label{ font-size:12px; color:var(--muted); font-weight:800; }
    .value{ font-family:var(--mono); font-weight:950; font-size:14px; text-align:right; }
    .red{ color:var(--red); }
    .green{ color:var(--green); }

    .tableWrap{
      background:var(--card);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      border-radius:var(--r);
      overflow:hidden;
    }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left;
      font-size:12px;
      background:#f1f5f9;
      border-bottom:1px solid var(--stroke);
      padding:10px 12px;
      position:sticky; top:0;
      z-index:2;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(15,23,42,.06);
      font-size:13px;
      white-space:nowrap;
    }
    tbody tr:hover{ background:#f8fafc; }
    .right{ text-align:right; }

    .msg{
      padding:14px;
      border-radius:var(--r);
      border:1px dashed var(--stroke);
      background:#fff;
      color:var(--muted);
      font-family:var(--mono);
      line-height:1.35;
    }

    @media print{
      .controls{ display:none; }
      body{ background:#fff; }
      .wrap{ max-width:none; padding:0; }
      .topbar,.card,.tableWrap{ box-shadow:none; }
      thead th{ position:static; }
    }
  </style>

  <script>
    const qs = new URLSearchParams(location.search);
    const get = (k, d="") => {
      const v = qs.get(k);
      return (v === null || v === undefined) ? d : v;
    };

    const safeNum = (x) => {
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    };

    const moneyRD = (n) => {
      const num = Number(n || 0);
      return "RD$ " + num.toLocaleString("es-DO", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function render(){
      // Acepta l/d o fechalunes/fechadomingo
      const l = get("l", get("fechalunes",""));
      const d = get("d", get("fechadomingo",""));
      const g = get("g", ""); // BI,BP,AB,PS,BG
      const r = get("r", ""); // id|BI|BP|AB|PS|BG~...

      document.getElementById("range").textContent =
        (l && d) ? `Semana: ${l} ‚Üí ${d}` : "Semana: (sin fechas)";

      // Si no viene r, mostramos error CLARO (nada de ‚Äúcargando‚Äù)
      if (!r){
        document.getElementById("msg").innerHTML =
          "Faltan datos en la URL.<br><br>" +
          "Debes enviar el par√°metro <strong>r</strong> con los grupos (ej: <code>r=1|100|80|20|5|85~2|...</code>).<br>" +
          "Opcional: <strong>g</strong> para el total general (ej: <code>g=BI,BP,AB,PS,BG</code>).";
        document.getElementById("msg").style.display = "block";
        document.getElementById("generalCard").style.display = "none";
        document.getElementById("tableWrap").style.display = "none";
        return;
      }

      // General card (si viene g)
      if (g){
        const parts = g.split(",");
        const generalObj = {
          bi: safeNum(parts[0]),
          bp: safeNum(parts[1]),
          ab: safeNum(parts[2]),
          ps: safeNum(parts[3]),
          bg: safeNum(parts[4]),
        };

        document.getElementById("generalCard").innerHTML = `
          <div class="card-h">
            <div class="name">TOTAL GENERAL</div>
            <div class="pill">${escapeHtml(l)} ‚Üí ${escapeHtml(d)}</div>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="label">Balance inicial</div><div class="value">${moneyRD(generalObj.bi)}</div></div>
            <div class="kpi"><div class="label">Total de abonos</div><div class="value green">${moneyRD(generalObj.ab)}</div></div>
            <div class="kpi"><div class="label">Pr√©stamos de semana</div><div class="value red">${moneyRD(generalObj.ps)}</div></div>
            <div class="kpi"><div class="label">Balance pendiente</div><div class="value red">${moneyRD(generalObj.bp)}</div></div>
            <div class="kpi wide"><div class="label">Balance general</div><div class="value">${moneyRD(generalObj.bg)}</div></div>
          </div>
        `;
        document.getElementById("generalCard").style.display = "block";
      } else {
        document.getElementById("generalCard").style.display = "none";
      }

      // Rows parse
      const allRows = r.split("~").map(x => x.trim()).filter(Boolean).map(line => {
        const p = line.split("|");
        return {
          id: (p[0] ?? "").trim(),
          bi: safeNum(p[1]),
          bp: safeNum(p[2]),
          ab: safeNum(p[3]),
          ps: safeNum(p[4]),
          bg: safeNum(p[5]),
        };
      });

      // Search + sort
      let sortDesc = true;
      const q = document.getElementById("q");
      const sortBtn = document.getElementById("sortBtn");

      function draw(){
        const term = (q.value || "").trim().toLowerCase();
        let filtered = allRows;
        if (term) filtered = allRows.filter(x => String(x.id).toLowerCase().includes(term));

        filtered.sort((a,b) => sortDesc ? (b.bp - a.bp) : (a.bp - b.bp));

        document.getElementById("rows").innerHTML = filtered.map(row => `
          <tr>
            <td><strong>GRUPO ${escapeHtml(row.id)}</strong></td>
            <td class="right">${moneyRD(row.bi)}</td>
            <td class="right green">${moneyRD(row.ab)}</td>
            <td class="right red">${moneyRD(row.ps)}</td>
            <td class="right ${row.bp < 0 ? "red" : ""}">${moneyRD(row.bp)}</td>
            <td class="right">${moneyRD(row.bg)}</td>
          </tr>
        `).join("");

        document.getElementById("tableWrap").style.display = "block";
        document.getElementById("msg").style.display = "none";
      }

      sortBtn.addEventListener("click", () => {
        sortDesc = !sortDesc;
        sortBtn.textContent = `Orden: Pendiente ${sortDesc ? "‚Üì" : "‚Üë"}`;
        draw();
      });

      q.addEventListener("input", draw);

      draw();
    }
  </script>
</head>

<body onload="render()">
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Pr√©stamos de Semana</h1>
        <div class="sub" id="range">Semana: ‚Äî</div>
      </div>

      <div class="controls">
        <div class="search">
          <span style="font-family:var(--mono);font-size:12px;color:var(--muted)">üîé</span>
          <input id="q" placeholder="Buscar grupo (ej: 32)..." autocomplete="off" />
        </div>
        <button class="btn" id="sortBtn">Orden: Pendiente ‚Üì</button>
        <button class="btn" onclick="window.print()">Imprimir</button>
      </div>
    </div>

    <div class="card" id="generalCard" style="display:none;"></div>

    <div class="tableWrap" id="tableWrap" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>Grupo</th>
            <th class="right">Balance Inicial</th>
            <th class="right">Total Abonos</th>
            <th class="right">Pr√©stamos Semana</th>
            <th class="right">Balance Pendiente</th>
            <th class="right">Balance General</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="msg" id="msg" style="display:none;"></div>
  </div>
</body>
</html>
